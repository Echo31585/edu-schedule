<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduSchedule Pro - 教育培训机构排课系统</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <!-- 登录页面 -->
    <div class="login-page" id="loginPage">
        <div class="login-container">
            <div class="login-logo">
                <h1>📚 EduSchedule Pro</h1>
                <p>教育培训机构排课与教务管理系统</p>
            </div>
            <div class="role-selector">
                <div class="role-card active" data-role="ADMIN" onclick="selectRole(this)">
                    <div class="role-icon">👩‍💼</div>
                    <div class="role-name">教务管理员</div>
                    <div class="role-desc">排课、审批、用户管理</div>
                </div>
                <div class="role-card" data-role="TEACHER" onclick="selectRole(this)">
                    <div class="role-icon">👨‍🏫</div>
                    <div class="role-name">教师</div>
                    <div class="role-desc">查看课表、填写记录</div>
                </div>
                <div class="role-card" data-role="STUDENT" onclick="selectRole(this)">
                    <div class="role-icon">👨‍🎓</div>
                    <div class="role-name">学生</div>
                    <div class="role-desc">查看课程、提交作业</div>
                </div>
                <div class="role-card" data-role="FINANCE" onclick="selectRole(this)">
                    <div class="role-icon">💰</div>
                    <div class="role-name">财务管理员</div>
                    <div class="role-desc">结算、报表、账本</div>
                </div>
            </div>
            <button class="login-btn" onclick="login()">登录系统</button>
            <div class="db-status" id="dbStatus">正在连接数据库...</div>
        </div>
    </div>

    <!-- 主应用容器 -->
    <div class="app-container" id="appContainer">
        <!-- 侧边栏 -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">📚 EduSchedule</div>
            </div>
            <nav class="sidebar-nav" id="sidebarNav"></nav>
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">👤</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">用户名</div>
                        <div class="user-role" id="userRole">角色</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 主内容区 -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
                    <h1 class="page-title" id="pageTitle">工作台</h1>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="showNotifications()">🔔<span class="notification-dot" id="notificationDot"></span></button>
                    <button class="logout-btn" onclick="logout()">🚪 退出</button>
                </div>
            </header>
            <div class="content-area" id="contentArea"></div>
        </main>
    </div>

    <!-- 用户模态框 -->
    <div class="modal-overlay" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="userModalTitle">新增用户</h3>
                <button class="modal-close" onclick="closeModal('userModal')">✕</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editUserId">
                <input type="hidden" id="editUserType">
                <div class="form-group">
                    <label class="form-label">用户类型 *</label>
                    <select class="form-select" id="userType">
                        <option value="teacher">教师</option>
                        <option value="student">学生</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">姓名 *</label>
                        <input type="text" class="form-input" id="userName_input" placeholder="请输入姓名">
                    </div>
                    <div class="form-group">
                        <label class="form-label">英文名</label>
                        <input type="text" class="form-input" id="userNameEn" placeholder="English Name">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">手机号 *</label>
                        <input type="tel" class="form-input" id="userPhone" placeholder="请输入手机号">
                    </div>
                    <div class="form-group">
                        <label class="form-label">邮箱</label>
                        <input type="email" class="form-input" id="userEmail" placeholder="example@edu.com">
                    </div>
                </div>
                <div class="form-group" id="subjectGroup">
                    <label class="form-label">科目</label>
                    <select class="form-select" id="userSubject">
                        <option value="math">数学</option>
                        <option value="english">英语</option>
                        <option value="physics">物理</option>
                        <option value="chemistry">化学</option>
                        <option value="chinese">语文</option>
                        <option value="biology">生物</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('userModal')">取消</button>
                <button class="btn btn-primary" onclick="saveUser()">保存</button>
            </div>
        </div>
    </div>

    <!-- 课程模态框 -->
    <div class="modal-overlay" id="courseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="courseModalTitle">新增课程</h3>
                <button class="modal-close" onclick="closeModal('courseModal')">✕</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editCourseId">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">课程名称 *</label>
                        <input type="text" class="form-input" id="courseName" placeholder="请输入课程名称">
                    </div>
                    <div class="form-group">
                        <label class="form-label">英文名称</label>
                        <input type="text" class="form-input" id="courseNameEn" placeholder="English Name">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">科目 *</label>
                        <select class="form-select" id="courseSubject">
                            <option value="math">数学</option>
                            <option value="english">英语</option>
                            <option value="physics">物理</option>
                            <option value="chemistry">化学</option>
                            <option value="chinese">语文</option>
                            <option value="biology">生物</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">课程类型</label>
                        <select class="form-select" id="courseType">
                            <option value="1v1">一对一</option>
                            <option value="1v3">一对三</option>
                            <option value="class">小班课</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">课时单价 (元) *</label>
                        <input type="number" class="form-input" id="coursePrice" placeholder="请输入单价" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">课时时长 (分钟)</label>
                        <select class="form-select" id="courseDuration">
                            <option value="45">45分钟</option>
                            <option value="60">60分钟</option>
                            <option value="90">90分钟</option>
                            <option value="120">120分钟</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('courseModal')">取消</button>
                <button class="btn btn-primary" onclick="saveCourse()">保存</button>
            </div>
        </div>
    </div>

    <!-- 排课模态框 -->
    <div class="modal-overlay" id="lessonModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="lessonModalTitle">新增排课</h3>
                <button class="modal-close" onclick="closeModal('lessonModal')">✕</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editLessonId">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">选择课程 *</label>
                        <select class="form-select" id="lessonCourse"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">选择教师 *</label>
                        <select class="form-select" id="lessonTeacher"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">选择学生 *</label>
                    <select class="form-select" id="lessonStudent"></select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">上课日期 *</label>
                        <input type="date" class="form-input" id="lessonDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">教室</label>
                        <select class="form-select" id="lessonClassroom">
                            <option value="A101">A101</option>
                            <option value="A102">A102</option>
                            <option value="A103">A103</option>
                            <option value="B201">B201</option>
                            <option value="B202">B202</option>
                            <option value="B203">B203</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">开始时间 *</label>
                        <select class="form-select" id="lessonStartTime">
                            <option value="08:00">08:00</option>
                            <option value="09:00">09:00</option>
                            <option value="10:00">10:00</option>
                            <option value="11:00">11:00</option>
                            <option value="14:00">14:00</option>
                            <option value="15:00">15:00</option>
                            <option value="16:00">16:00</option>
                            <option value="17:00">17:00</option>
                            <option value="19:00">19:00</option>
                            <option value="20:00">20:00</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">结束时间 *</label>
                        <select class="form-select" id="lessonEndTime">
                            <option value="09:00">09:00</option>
                            <option value="10:00">10:00</option>
                            <option value="11:00">11:00</option>
                            <option value="12:00">12:00</option>
                            <option value="15:00">15:00</option>
                            <option value="16:00">16:00</option>
                            <option value="17:00">17:00</option>
                            <option value="18:00">18:00</option>
                            <option value="20:00">20:00</option>
                            <option value="21:00">21:00</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('lessonModal')">取消</button>
                <button class="btn btn-primary" onclick="saveLesson()">保存</button>
            </div>
        </div>
    </div>

    <!-- 排课详情模态框 -->
    <div class="modal-overlay" id="lessonDetailModal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3 class="modal-title">📅 课程详情</h3>
                <button class="modal-close" onclick="closeModal('lessonDetailModal')">✕</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="lessonDetailId">
                <div id="lessonDetailContent"></div>
            </div>
            <div class="modal-footer" id="lessonDetailFooter">
                <button class="btn btn-danger" onclick="deleteLessonFromDetail()">🗑️ 删除</button>
                <button class="btn btn-warning" onclick="openLeaveModal()">📝 请假/调课</button>
                <button class="btn btn-success" onclick="completeLessonFromDetail()">✅ 完成课程</button>
                <button class="btn btn-primary" onclick="editLessonFromDetail()">✏️ 编辑</button>
            </div>
        </div>
    </div>

    <!-- Day 3 新增：学生充值模态框 -->
    <div class="modal-overlay" id="rechargeModal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3 class="modal-title">💰 课时充值</h3>
                <button class="modal-close" onclick="closeModal('rechargeModal')">✕</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="rechargeStudentId">
                <div class="recharge-info">
                    <div class="info-row">
                        <span class="info-label">学生姓名：</span>
                        <span class="info-value" id="rechargeStudentName">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">当前余额：</span>
                        <span class="info-value" id="rechargeCurrentBalance">0 课时</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">充值课时数 *</label>
                    <input type="number" class="form-input" id="rechargeAmount" placeholder="请输入充值课时数" min="1" value="10" onchange="updateRechargePreview()">
                </div>
                <div class="form-group">
                    <label class="form-label">备注</label>
                    <input type="text" class="form-input" id="rechargeReason" placeholder="例如：2月份课时充值">
                </div>
                <div class="recharge-preview">
                    <span>充值后余额：</span>
                    <strong id="rechargeNewBalance">10 课时</strong>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('rechargeModal')">取消</button>
                <button class="btn btn-success" onclick="confirmRecharge()">💰 确认充值</button>
            </div>
        </div>
    </div>

    <!-- Day 3 新增：请假/调课申请模态框 -->
    <div class="modal-overlay" id="leaveModal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3 class="modal-title">📝 请假/调课申请</h3>
                <button class="modal-close" onclick="closeModal('leaveModal')">✕</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="leaveLessonId">
                <div class="leave-lesson-info" id="leaveLessonInfo"></div>
                <div class="form-group">
                    <label class="form-label">申请类型 *</label>
                    <select class="form-select" id="leaveType" onchange="toggleRescheduleFields()">
                        <option value="请假">请假（取消本次课程）</option>
                        <option value="调课">调课（改期上课）</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">申请原因 *</label>
                    <textarea class="form-input" id="leaveReason" rows="3" placeholder="请填写申请原因"></textarea>
                </div>
                <div id="rescheduleFields" style="display:none;">
                    <div class="form-group">
                        <label class="form-label">调整日期 *</label>
                        <input type="date" class="form-input" id="rescheduleDate">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">开始时间</label>
                            <select class="form-select" id="rescheduleStartTime">
                                <option value="08:00">08:00</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                                <option value="19:00">19:00</option>
                                <option value="20:00">20:00</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">结束时间</label>
                            <select class="form-select" id="rescheduleEndTime">
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="12:00">12:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                                <option value="18:00">18:00</option>
                                <option value="20:00">20:00</option>
                                <option value="21:00">21:00</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('leaveModal')">取消</button>
                <button class="btn btn-primary" onclick="submitLeaveRequest()">提交申请</button>
            </div>
        </div>
    </div>

    <!-- Day 3 新增：审批详情模态框 -->
    <div class="modal-overlay" id="approvalDetailModal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3 class="modal-title">📋 审批详情</h3>
                <button class="modal-close" onclick="closeModal('approvalDetailModal')">✕</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="approvalDetailId">
                <input type="hidden" id="approvalDetailType">
                <input type="hidden" id="approvalDetailLessonId">
                <div id="approvalDetailContent"></div>
                <div id="approvalRescheduleFields" style="display:none;">
                    <hr style="margin: 16px 0;">
                    <h4 style="margin-bottom: 12px;">确认调课时间</h4>
                    <div class="form-group">
                        <label class="form-label">调整日期 *</label>
                        <input type="date" class="form-input" id="approvalNewDate">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">开始时间</label>
                            <select class="form-select" id="approvalNewStartTime">
                                <option value="">保持原时间</option>
                                <option value="08:00">08:00</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="19:00">19:00</option>
                                <option value="20:00">20:00</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">结束时间</label>
                            <select class="form-select" id="approvalNewEndTime">
                                <option value="">保持原时间</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                                <option value="20:00">20:00</option>
                                <option value="21:00">21:00</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="processApproval('REJECTED')">❌ 拒绝</button>
                <button class="btn btn-success" onclick="processApproval('APPROVED')">✅ 通过</button>
            </div>
        </div>
    </div>

    <!-- Day 3 新增：教师结算详情模态框 -->
    <div class="modal-overlay" id="settlementDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">💰 教师结算详情</h3>
                <button class="modal-close" onclick="closeModal('settlementDetailModal')">✕</button>
            </div>
            <div class="modal-body">
                <div id="settlementDetailContent"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('settlementDetailModal')">关闭</button>
                <button class="btn btn-primary" onclick="exportSettlement()">📥 导出</button>
            </div>
        </div>
    </div>

    <!-- 引入脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/database.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
